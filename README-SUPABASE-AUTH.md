# Supabase 认证与订阅功能实现指南

本文档提供了如何在 Expo 应用中设置和使用 Supabase 认证和订阅功能的详细指南。

## 设置步骤

### 1. 创建 Supabase 项目

1. 注册或登录 [Supabase](https://supabase.com)
2. 创建一个新项目
3. 项目创建完成后，前往 Project Settings > API 查找：
   - 项目 URL
   - 项目匿名密钥（anon key）

### 2. 配置数据库表和函数

1. 在 Supabase 仪表板中，导航到 SQL 编辑器
2. 复制 `supabase-setup.sql` 文件中的 SQL 脚本
3. 在 SQL 编辑器中粘贴并执行脚本
4. 这将创建以下表和函数：
   - `profiles` 表：存储用户的附加信息
   - `subscriptions` 表：存储用户的订阅信息
   - `user_points` 表：存储用户的积分信息
   - 触发器和函数：自动处理新用户创建和用户名更新

### 3. 配置认证设置

在 Supabase 仪表板中：

1. 导航到 Authentication > Providers
2. 确保 Email 提供商已启用
3. 根据需要配置电子邮件确认设置
4. 如果需要，配置其他提供商（如 Google、Facebook 等）

## 项目结构

本项目的认证和订阅功能由以下文件组成：

- `/lib/supabase.ts` - Supabase 客户端配置
- `/contexts/auth.tsx` - 认证上下文提供者，包含用户信息、订阅和积分管理
- `/app/_layout.tsx` - 应用根布局，包含认证流程和路由保护
- `/app/auth/` - 认证屏幕（登录、注册）
- `/app/(tabs)/profile.tsx` - 用户资料页面，包含订阅管理和积分显示

## 功能说明

### 认证功能

- 用户注册和登录（使用电子邮件/密码）
- 认证状态管理（在应用重启后保持）
- 基于认证状态的路由保护
- 用户资料管理（用户名编辑）

### 订阅功能

- 免费和专业版订阅计划
- 订阅状态显示和管理
- 积分系统（基于订阅计划的不同积分额度）
- 积分使用情况显示

## 使用指南

### 认证流程

1. 用户首次访问应用时会被重定向到登录页面
2. 用户可以选择登录或注册新账户
3. 注册后，用户需要验证电子邮件（如果在 Supabase 中启用了此功能）
4. 登录成功后，用户将被重定向到主页

### 订阅管理

1. 用户可以在资料页面查看当前订阅状态
2. 免费用户可以升级到专业版计划
3. 专业版用户可以取消订阅，降级到免费计划
4. 订阅变更会立即反映在用户界面上

### 积分系统

1. 免费用户有 15 个积分
2. 专业版用户有 1000 个积分
3. 用户可以在资料页面查看积分余额和使用情况
4. 积分使用情况通过进度条直观显示

## 故障排除

- 如果遇到连接问题，请验证 Supabase URL 和匿名密钥是否正确
- 检查 Supabase 项目的认证设置中的电子邮件验证设置
- 监控 Supabase 日志以查看任何认证错误
- 如果数据库表未正确创建，请手动执行 `supabase-setup.sql` 中的 SQL 脚本

## 开发注意事项

- 在生产环境中，应该实现真实的支付集成来处理订阅
- 当前的订阅管理是模拟的，实际应用中应与支付提供商集成
- 积分系统可以根据实际需求进行调整和扩展
